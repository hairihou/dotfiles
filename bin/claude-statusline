#!/usr/bin/env bash
set -euo pipefail

eval "$(jq -r '
  @sh "model=\(.model.display_name)",
  @sh "dir=\(.workspace.current_dir)",
  "pct=\(.context_window.used_percentage // 0 | floor)",
  "cost=\(.cost.total_cost_usd // 0)"
')"

green='\033[92m'; yellow='\033[93m'; red='\033[91m'; magenta='\033[35m'; gray='\033[90m'; reset='\033[0m'
if [[ "$pct" -ge 90 ]]; then bar_color="$red"
elif [[ "$pct" -ge 70 ]]; then bar_color="$yellow"
else bar_color="$green"; fi

filled=$((pct / 10)); empty=$((10 - filled))
bar=$(printf "%${filled}s" | tr ' ' '█')$(printf "%${empty}s" | tr ' ' '░')

# Git branch (cached per directory)
cache_file="/tmp/claude-statusline-${dir//\//-}"
branch=""
if [[ ! -f "$cache_file" ]] || [[ $(($(date +%s) - $(stat -f %m "$cache_file"))) -gt 5 ]]; then
  branch=$(git -C "$dir" branch --show-current 2>/dev/null) || true
  echo "$branch" > "$cache_file"
else
  branch=$(< "$cache_file")
fi

git_info=""
[[ -n "$branch" ]] && git_info=" | ${magenta}${branch}${reset}"

cost_fmt=$(printf '$%.2f' "$cost")
echo -e "[$model] ${dir##*/}${git_info} ${bar_color}${bar}${reset} ${pct}% ${gray}${cost_fmt}${reset}"
