#!/usr/bin/env bash
set -euo pipefail

readonly extensions_list="$HOME/dotfiles/public/vscode-extensions.txt"
readonly extensions_dir="$HOME/.vscode/extensions"
readonly ignored_extensions=(
  "tailwindlabs.tailwindcss-vscode-theme"
)

dump_extensions() {
  code --list-extensions | sort > "$extensions_list"
  local count=$(wc -l < "$extensions_list")
  echo "Dumped $count extensions to $extensions_list"
}

prune_extensions() {
  local listed
  listed=$(grep -v '^#' "$extensions_list" | grep -v '^$')

  local to_remove=()
  while IFS= read -r ext; do
    [[ -z "$ext" ]] && continue
    [[ " ${ignored_extensions[*]} " =~ " ${ext} " ]] && continue
    echo "$listed" | grep -qx "$ext" && continue
    to_remove+=("$ext")
  done < <(code --list-extensions 2>/dev/null)

  if [[ ${#to_remove[@]} -eq 0 ]]; then
    echo 'No extensions to remove'
    return 0
  fi

  echo "The following extensions are not in $extensions_list:"
  for ext in "${to_remove[@]}"; do
    echo "  - $ext"
  done
  echo -n 'Remove these extensions? (y/n): '
  read -r response < /dev/tty

  if [[ ! "$response" =~ ^[Yy]([Ee][Ss])?$ ]]; then
    echo 'Cancelled'
    return 0
  fi

  local removed=0
  for ext in "${to_remove[@]}"; do
    echo "Uninstalling $ext..."
    if code --uninstall-extension "$ext" > /dev/null 2>&1; then
      removed=$((removed + 1))
    fi
  done

  echo "Removed $removed extensions"
}

sync_extensions() {
  local installed
  installed=$(code --list-extensions 2>/dev/null || echo "")

  local listed=()
  while IFS= read -r ext; do
    [[ -z "$ext" || "$ext" =~ ^# ]] && continue
    [[ " ${ignored_extensions[*]} " =~ " ${ext} " ]] && continue
    listed+=("$ext")
  done < "$extensions_list"

  local total=${#listed[@]}
  local added=0
  local failed=0
  local skipped=0
  local current=0

  for ext in "${listed[@]}"; do
    current=$((current + 1))
    echo "[$current/$total] $ext"

    if echo "$installed" | grep -qx "$ext"; then
      echo 'Already installed'
      skipped=$((skipped + 1))
    else
      if code --install-extension "$ext" > /dev/null 2>&1; then
        echo 'Installed'
        added=$((added + 1))
      else
        echo 'Failed'
        failed=$((failed + 1))
      fi
    fi
  done

  echo "Added: $added, Failed: $failed, Skipped: $skipped"

  rm -f "$extensions_dir/.obsolete" 2>/dev/null || true

  local state="$extensions_dir/extensions.json"
  if [[ -f "$state" ]] && command -v jq > /dev/null 2>&1; then
    jq 'map(del(.pinned))' "$state" > "${state}.tmp" && mv "${state}.tmp" "$state"
  fi
}

main() {
  if ! command -v code > /dev/null 2>&1; then
    echo "Error: 'code' command not found"
    exit 1
  fi

  case "${1:-}" in
    --dump)
      dump_extensions
      ;;
    --prune)
      if [[ ! -f "$extensions_list" ]]; then
        echo "Error: $extensions_list not found"
        exit 1
      fi
      prune_extensions
      ;;
    '')
      if [[ ! -f "$extensions_list" ]]; then
        echo "Error: $extensions_list not found"
        echo 'Run with --dump to create it'
        exit 1
      fi
      sync_extensions
      ;;
    *)
      echo "Error: Unknown option: $1"
      exit 1
      ;;
  esac
}

main "$@"
